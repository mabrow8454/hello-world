<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>King Arthur and the Knights of the Round Table</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-color: #f5f1e8;
            --text-color: #333;
            --page-bg: #fffef9;
            --ui-bg: #232f3e;
            --ui-text: #fff;
            --accent: #48a3c6;
            --bookmark-color: #48a3c6;
        }

        .dark-mode {
            --bg-color: #000;
            --text-color: #ccc;
            --page-bg: #1a1a1a;
            --ui-bg: #232f3e;
        }

        .sepia-mode {
            --bg-color: #f4ecd8;
            --text-color: #5b4636;
            --page-bg: #f9f3e3;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: var(--bg-color);
            color: var(--text-color);
            user-select: none;
        }

        /* Top Header Bar */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--ui-bg);
            color: var(--ui-text);
            z-index: 100;
            transform: translateY(-100%);
            transition: transform 0.25s ease;
        }

        .header.visible {
            transform: translateY(0);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn {
            background: none;
            border: none;
            color: var(--ui-text);
            cursor: pointer;
            padding: 8px;
            font-size: 1.3rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }

        .header-btn:hover {
            opacity: 1;
        }

        .header-btn.aa-btn {
            font-family: Georgia, serif;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .book-title {
            text-align: center;
            padding: 8px 12px 12px;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        /* Bottom Bar */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--ui-bg);
            color: var(--ui-text);
            padding: 12px 16px 20px;
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.25s ease;
        }

        .footer.visible {
            transform: translateY(0);
        }

        .page-info {
            text-align: center;
            font-size: 0.85rem;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .grid-btn {
            background: none;
            border: none;
            color: var(--ui-text);
            cursor: pointer;
            padding: 4px;
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .grid-btn:hover {
            opacity: 1;
        }

        .page-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            cursor: pointer;
        }

        .page-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .page-markers {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            opacity: 0.6;
            margin-top: 4px;
            padding: 0 4px;
        }

        /* Reading Area */
        .reader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .pages-container {
            display: flex;
            transition: transform 0.3s ease;
            height: 100%;
        }

        .page {
            width: 100vw;
            height: 100%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            background: var(--page-bg);
            position: relative;
        }

        .page-content {
            flex: 1;
            padding: 40px 30px;
            overflow: hidden;
            line-height: 1.75;
            font-size: 1.1em;
        }

        .page-content p {
            margin-bottom: 1.2em;
            text-align: justify;
            text-indent: 1.5em;
        }

        .page-content p:first-child {
            text-indent: 0;
        }

        .page-content .chapter-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
        }

        .page-content .chapter-number {
            font-size: 0.8em;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 8px;
        }

        .page-content .chapter-title {
            font-size: 1.6em;
            font-weight: normal;
        }

        .page-content p.first-para::first-letter {
            font-size: 3.2em;
            float: left;
            line-height: 1;
            padding-right: 8px;
            padding-top: 4px;
            color: #8b4513;
        }

        .dark-mode .page-content p.first-para::first-letter {
            color: #d4a574;
        }

        /* Bookmark ribbon on page */
        .page-bookmark {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 1.8rem;
            color: var(--bookmark-color);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .page-bookmark.visible {
            opacity: 0.3;
        }

        .page-bookmark.active {
            opacity: 1;
        }

        /* Touch zones */
        .touch-zone {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 25%;
            z-index: 50;
        }

        .touch-zone.left {
            left: 0;
            cursor: w-resize;
        }

        .touch-zone.right {
            right: 0;
            cursor: e-resize;
        }

        .touch-zone.center {
            left: 25%;
            right: 25%;
            width: 50%;
            cursor: pointer;
        }

        /* Panels */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 150;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s;
        }

        .overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Table of Contents */
        .toc-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 320px;
            max-width: 85%;
            height: 100%;
            background: var(--page-bg);
            z-index: 200;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .toc-panel.visible {
            transform: translateX(0);
        }

        .toc-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toc-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            padding: 4px;
        }

        .toc-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
        }

        .toc-item {
            padding: 14px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: background 0.2s;
        }

        .toc-item:hover {
            background: rgba(0,0,0,0.03);
        }

        .toc-item.active {
            background: rgba(72, 163, 198, 0.1);
            border-left: 3px solid var(--accent);
        }

        .toc-item .chapter-num {
            font-size: 0.75em;
            color: #888;
            display: block;
            margin-bottom: 2px;
        }

        /* Search Panel */
        .search-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--page-bg);
            z-index: 200;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .search-panel.visible {
            transform: translateY(0);
        }

        .search-header {
            padding: 12px 16px;
            background: var(--ui-bg);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-input {
            flex: 1;
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            background: rgba(255,255,255,0.9);
        }

        .search-input:focus {
            outline: none;
        }

        .search-close {
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            padding: 8px;
        }

        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .search-result {
            padding: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .search-result:hover {
            background: rgba(0,0,0,0.03);
        }

        .search-result .context {
            font-size: 0.9em;
            color: #666;
        }

        .search-result .highlight {
            background: yellow;
            color: #000;
        }

        .search-result .chapter-name {
            font-size: 0.8em;
            color: var(--accent);
            margin-top: 4px;
        }

        /* Font Settings Panel */
        .font-panel {
            position: fixed;
            top: 60px;
            right: 10px;
            width: 280px;
            background: var(--page-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 200;
            padding: 20px;
            display: none;
        }

        .font-panel.visible {
            display: block;
        }

        .font-section {
            margin-bottom: 20px;
        }

        .font-section:last-child {
            margin-bottom: 0;
        }

        .font-section label {
            display: block;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .font-size-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .font-btn {
            width: 44px;
            height: 44px;
            border: 1px solid #ddd;
            background: var(--page-bg);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        .font-btn:hover {
            background: #eee;
        }

        .font-size-display {
            flex: 1;
            text-align: center;
            font-size: 1rem;
        }

        .theme-options {
            display: flex;
            gap: 10px;
        }

        .theme-btn {
            flex: 1;
            height: 44px;
            border-radius: 8px;
            border: 2px solid #ddd;
            cursor: pointer;
            font-size: 0.8em;
        }

        .theme-btn.light { background: #fffef9; color: #333; }
        .theme-btn.sepia { background: #f9f3e3; color: #5b4636; }
        .theme-btn.dark { background: #1a1a1a; color: #ccc; }

        .theme-btn.active {
            border-color: var(--accent);
        }

        /* Page Grid Navigator */
        .page-grid {
            position: fixed;
            bottom: 80px;
            left: 10px;
            right: 10px;
            max-height: 200px;
            background: var(--ui-bg);
            border-radius: 12px;
            padding: 12px;
            z-index: 200;
            display: none;
            overflow-x: auto;
            white-space: nowrap;
        }

        .page-grid.visible {
            display: block;
        }

        .page-grid-inner {
            display: inline-flex;
            gap: 8px;
        }

        .page-thumb {
            width: 60px;
            height: 80px;
            background: var(--page-bg);
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            color: var(--text-color);
            border: 2px solid transparent;
        }

        .page-thumb.active {
            border-color: var(--accent);
        }

        .page-thumb:hover {
            opacity: 0.8;
        }

        /* Loading */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
            transition: opacity 0.5s;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-book {
            width: 140px;
            height: 200px;
            background: linear-gradient(135deg, #8b4513, #654321);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border-left: 6px solid #5a3a1f;
            margin-bottom: 20px;
        }

        .loading-book .icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .loading-book h2 {
            color: #ffd700;
            font-size: 0.85rem;
            text-align: center;
            padding: 0 15px;
        }

        .loading-text {
            color: #888;
            font-size: 0.9rem;
        }

        /* Page turn animation */
        .page.turning-left {
            animation: turnLeft 0.3s ease;
        }

        .page.turning-right {
            animation: turnRight 0.3s ease;
        }

        @keyframes turnLeft {
            0% { transform: translateX(0); }
            100% { transform: translateX(-10px); }
        }

        @keyframes turnRight {
            0% { transform: translateX(0); }
            100% { transform: translateX(10px); }
        }

        /* Responsive */
        @media (max-width: 500px) {
            .page-content {
                padding: 30px 20px;
                font-size: 1em;
            }

            .toc-panel {
                width: 100%;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-book">
            <div class="icon">&#9876;</div>
            <h2>King Arthur and the Knights of the Round Table</h2>
        </div>
        <p class="loading-text">Loading...</p>
    </div>

    <!-- Header -->
    <header class="header" id="header">
        <div class="header-top">
            <div class="header-left">
                <button class="header-btn" id="tocBtn" title="Contents">&#9776;</button>
            </div>
            <div class="header-right">
                <button class="header-btn" id="searchBtn" title="Search">&#128269;</button>
                <button class="header-btn" id="bookmarkBtn" title="Bookmark">&#128278;</button>
                <button class="header-btn aa-btn" id="fontBtn" title="Font Settings">Aa</button>
            </div>
        </div>
        <div class="book-title" id="bookTitle">King Arthur and the Knights of the Round Table</div>
    </header>

    <!-- Footer -->
    <footer class="footer" id="footer">
        <div class="page-info" id="pageInfo">Page 1 of 45 Â· 2%</div>
        <div class="slider-container">
            <button class="grid-btn" id="gridBtn" title="Page Overview">&#9783;</button>
            <input type="range" class="page-slider" id="pageSlider" min="1" max="100" value="1">
        </div>
        <div class="page-markers">
            <span id="sliderStart">1</span>
            <span id="sliderEnd">45</span>
        </div>
    </footer>

    <!-- Reader Area -->
    <div class="reader" id="reader">
        <div class="pages-container" id="pagesContainer"></div>
    </div>

    <!-- Touch Zones -->
    <div class="touch-zone left" id="touchLeft"></div>
    <div class="touch-zone center" id="touchCenter"></div>
    <div class="touch-zone right" id="touchRight"></div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Table of Contents -->
    <nav class="toc-panel" id="tocPanel">
        <div class="toc-header">
            <h2>Contents</h2>
            <button class="close-btn" id="closeToc">&times;</button>
        </div>
        <ul class="toc-list" id="tocList"></ul>
    </nav>

    <!-- Search Panel -->
    <div class="search-panel" id="searchPanel">
        <div class="search-header">
            <input type="text" class="search-input" id="searchInput" placeholder="Search in book...">
            <button class="search-close" id="closeSearch">Cancel</button>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>

    <!-- Font Settings Panel -->
    <div class="font-panel" id="fontPanel">
        <div class="font-section">
            <label>Font Size</label>
            <div class="font-size-controls">
                <button class="font-btn" id="fontDecrease">A-</button>
                <span class="font-size-display" id="fontSizeDisplay">100%</span>
                <button class="font-btn" id="fontIncrease">A+</button>
            </div>
        </div>
        <div class="font-section">
            <label>Theme</label>
            <div class="theme-options">
                <button class="theme-btn light active" data-theme="light">Light</button>
                <button class="theme-btn sepia" data-theme="sepia">Sepia</button>
                <button class="theme-btn dark" data-theme="dark">Dark</button>
            </div>
        </div>
    </div>

    <!-- Page Grid Navigator -->
    <div class="page-grid" id="pageGrid">
        <div class="page-grid-inner" id="pageGridInner"></div>
    </div>

    <script>
        // Book Content
        const bookContent = [
            {
                title: "The Sword in the Stone",
                number: "Chapter 1",
                content: `<p class="first-para">Long ago, in the land of Britain, there lived a great king named Uther Pendragon. He was a strong and brave king, but he had no son to rule after him. This made him very sad.</p>
                <p>One day, the wise wizard Merlin came to see the king. Merlin had long white hair and a long white beard. His eyes were bright and full of magic.</p>
                <p>"Do not worry, King Uther," said Merlin. "You will have a son. But you must give the boy to me. I will keep him safe and teach him many things."</p>
                <p>The king did not want to give away his son. But he trusted Merlin. "Very well," he said. "I will do as you say."</p>
                <p>Soon, a baby boy was born. He had bright eyes and golden hair. The king named him Arthur. That same night, Merlin came to the castle. He took the baby to a good knight named Sir Ector.</p>
                <p>"Raise this child as your own," Merlin told Sir Ector. "Do not tell anyone who he really is. One day, he will be king."</p>
                <p>Sir Ector loved little Arthur. He raised him with his own son, Kay. The two boys grew up together like brothers. Arthur was kind and brave. Kay was proud but loyal.</p>
                <p>When Arthur was fifteen years old, King Uther died. The kingdom had no king. The lords and knights began to fight. Everyone wanted to be king. The land was in great trouble.</p>
                <p>Then a strange thing happened. On Christmas morning, a great stone appeared in the churchyard. A beautiful sword stuck out of the stone. On the sword were these words: "Whoever pulls this sword from the stone is the true King of Britain."</p>
                <p>Many strong men tried to pull out the sword. Lords, knights, and warriors all came to try. But no one could move the sword. It stayed in the stone as if it grew there.</p>
                <p>"We will have a tournament," said the lords. "Whoever pulls the sword will be our king."</p>
                <p>Sir Ector brought his son Kay to the tournament. Arthur came too. Kay was going to fight for the first time. He was very excited.</p>
                <p>But when they arrived, Kay discovered he had forgotten his sword at home. "Arthur!" he said. "Go back and get my sword. Quickly!"</p>
                <p>Arthur rode fast to get the sword. But the house was locked. Everyone had gone to the tournament. Arthur did not know what to do.</p>
                <p>Then he saw the sword in the stone. "I will borrow this one," he thought. He walked up to the stone. He put his hand on the sword. He pulled. The sword came out easily.</p>
                <p>Arthur rode back to Kay. "Here is a sword," he said. Kay looked at the sword. His eyes grew wide. "Father!" he cried. "Look! The sword from the stone! I am the king!"</p>
                <p>Sir Ector looked at his son. "Did you pull this sword from the stone?" he asked.</p>
                <p>Kay wanted to say yes. But he could not lie to his father. "No," he said sadly. "Arthur gave it to me."</p>
                <p>Sir Ector took Arthur back to the stone. "Put the sword back," he said. Arthur put it back easily. Then Sir Ector tried to pull it out. He could not. Kay tried. He could not. Many knights tried. No one could pull it out.</p>
                <p>"Now you try, Arthur," said Sir Ector.</p>
                <p>Arthur pulled the sword. It came out easily, like a knife from butter. All the people gasped. Sir Ector knelt before Arthur. Kay knelt too.</p>
                <p>"You are our true king," said Sir Ector. "I must tell you the truth. You are not my son. The wizard Merlin brought you to me when you were a baby. You are the son of King Uther Pendragon."</p>
                <p>Arthur was amazed. He was a king's son! He looked at the sword in his hand. It shone like fire in the sun.</p>
                <p>Some lords were angry. "How can this boy be king?" they said. "He is just a child!" But the sword had chosen Arthur. No one else could pull it from the stone. At last, everyone agreed. Arthur was crowned King of Britain.</p>`
            },
            {
                title: "The Wizard Merlin",
                number: "Chapter 2",
                content: `<p class="first-para">After Arthur became king, Merlin came to help him. The old wizard knew everything about the past and the future. He had magic powers that no one could understand.</p>
                <p>"You will be a great king, Arthur," said Merlin. "But you must be wise. You must be fair. You must help the weak and fight the strong who do wrong."</p>
                <p>Arthur listened to everything Merlin said. The wizard became his teacher and his friend. They talked for hours about how to rule the kingdom.</p>
                <p>But not everyone was happy. Some kings and lords did not want Arthur to rule. They gathered their armies. They marched to fight young King Arthur.</p>
                <p>"Do not worry," said Merlin. "I will help you."</p>
                <p>The battle was fierce. Arthur fought bravely with his sword. But there were too many enemies. The sword broke in two!</p>
                <p>Arthur was afraid. Without a sword, how could he win? But Merlin used his magic. A thick mist covered the battlefield. Arthur's enemies could not see. They became confused and ran away.</p>
                <p>"You saved me," said Arthur. "But now I have no sword."</p>
                <p>Merlin smiled his mysterious smile. "Come with me," he said. "I know where you can find a new sword. A better sword. The best sword in all the world."</p>
                <p>Merlin took Arthur to a lake deep in the forest. The water was dark and still. Mist floated above it like smoke.</p>
                <p>"Watch," said Merlin.</p>
                <p>Arthur watched. Slowly, a hand rose from the water. It was a woman's hand, pale as snow. In it was a sword. The most beautiful sword Arthur had ever seen. It glowed with a blue light.</p>
                <p>"That is Excalibur," said Merlin. "It was made by magic. No sword can break it. No enemy can stand against it."</p>
                <p>"How can I get it?" asked Arthur.</p>
                <p>"See that boat?" Merlin pointed to a small boat by the shore. "Row to the sword and take it. The Lady of the Lake will give it to you."</p>
                <p>Arthur rowed the boat across the dark water. When he reached the hand, he took the sword. The hand let go and sank beneath the water.</p>
                <p>Arthur looked at Excalibur. The blade was bright silver. The handle was gold with precious stones. It was light in his hand but strong as steel.</p>
                <p>"Thank you," Arthur called to the lake. He did not know if anyone heard him.</p>
                <p>"The sword is very special," said Merlin when Arthur returned. "But the scabbard is even more special. While you wear the scabbard, you will never bleed from any wound. Guard it well."</p>
                <p>Arthur wore Excalibur at his side. He wore the magic scabbard too. With Merlin's help, he won many battles. He brought peace to Britain. The lords who had fought against him now knelt before him.</p>
                <p>But Merlin knew that his time with Arthur was ending. "I must leave you soon," he told the king.</p>
                <p>"Leave? Why?" Arthur was sad. He did not want to lose his friend.</p>
                <p>"I have seen the future," said Merlin. "A beautiful woman will put me under a spell. I will sleep under a great stone forever. I cannot change this. It is my fate."</p>
                <p>"Fight the spell!" said Arthur. "Use your magic!"</p>
                <p>Merlin shook his head. "Even I cannot fight fate. But do not worry. I have taught you well. You will be a good king. Remember everything I told you. Be brave. Be fair. Be kind."</p>
                <p>Soon after, Merlin met a beautiful woman named Nimue. She was one of the Ladies of the Lake. She wanted to learn Merlin's magic. Merlin loved her and taught her many spells.</p>
                <p>But Nimue was afraid of Merlin's power. One day, she used his own magic against him. She put him under a spell. She sealed him in a cave behind a great stone. There Merlin sleeps to this day.</p>
                <p>Arthur was very sad when Merlin did not return. But he remembered his teacher's words. He ruled wisely and well. He became the greatest king Britain had ever known.</p>`
            },
            {
                title: "The Round Table",
                number: "Chapter 3",
                content: `<p class="first-para">King Arthur built a great castle called Camelot. It had tall towers and strong walls. It stood on a hill where everyone could see it. Inside were beautiful rooms and a great hall.</p>
                <p>Arthur married a beautiful princess named Guinevere. She had dark hair and kind eyes. She came from a neighboring kingdom. Her father gave Arthur a wedding present: a great round table.</p>
                <p>"This table is special," said Guinevere's father. "It has no head and no foot. Everyone who sits at this table is equal. No one is more important than another."</p>
                <p>Arthur loved the table. "This is perfect," he said. "My knights will sit here with me. We will all be equal. We will make decisions together."</p>
                <p>The Round Table was very large. One hundred and fifty knights could sit around it. Each seat had a name written in gold letters. The names appeared by magic when the right knight sat down.</p>
                <p>Arthur gathered the bravest knights in the land. They came from many kingdoms. Each one had done brave deeds. Each one had proved his honor.</p>
                <p>"Welcome to Camelot," Arthur said to them. "Welcome to the Round Table. Together, we will make Britain a good place. We will protect the weak. We will fight evil. We will seek justice."</p>
                <p>The knights took an oath. They promised to be brave and true. They promised to help people in need. They promised to never do wrong or evil. They promised to be loyal to King Arthur.</p>
                <p>Sir Lancelot was the bravest knight. He came from France. He had golden hair and was very handsome. No one could beat him in a fight. He became Arthur's best friend.</p>
                <p>Sir Gawain was Arthur's nephew. He was strong and proud. His strength grew as the sun rose higher. At noon, he was strongest of all. But when the sun set, he grew weak again.</p>
                <p>Sir Galahad was the purest knight. He was Lancelot's son. His heart was good and true. He never told lies. He never did wrong. Many said he was perfect.</p>
                <p>Sir Percival was a simple knight. He grew up in the forest, far from castles and courts. He did not know the rules of knighthood. But his heart was brave and pure.</p>
                <p>Sir Tristan was a great fighter and poet. He could sing beautiful songs. He was also the best hunter in the land. Sadly, he loved a woman he could not marry.</p>
                <p>Sir Kay was Arthur's foster brother. Sometimes he was proud and mean. But he was loyal to Arthur. He always stood by the king.</p>
                <p>Many other knights sat at the Round Table. Sir Bedivere, Sir Bors, Sir Lamorak, Sir Gareth. Each one was brave. Each one had his own story.</p>
                <p>One seat was always empty. It was called the Siege Perilous, which means the Dangerous Seat. Magic writing said that only the purest knight could sit there. Anyone else would die.</p>
                <p>"Who will sit in that seat?" the knights asked.</p>
                <p>"One day, the right knight will come," said Arthur. "Until then, we must wait."</p>
                <p>The Knights of the Round Table did many great deeds. They rode across the land, helping people. They fought dragons and giants. They rescued prisoners and protected villages.</p>
                <p>Stories of their adventures spread everywhere. People came from far away to see Camelot. Singers wrote songs about the brave knights. Britain was proud of its king and his knights.</p>
                <p>Those were the golden days of Camelot. The days when good men fought for what was right. The days when King Arthur and his knights sat together as equals, planning how to make the world better.</p>`
            },
            {
                title: "Sir Lancelot",
                number: "Chapter 4",
                content: `<p class="first-para">Sir Lancelot was the greatest of all the knights. He was tall and strong with golden hair. His eyes were blue like the summer sky. When he fought, no one could beat him. When he spoke, everyone listened.</p>
                <p>Lancelot came to Camelot from a far country. He wanted to serve King Arthur. He had heard stories of the Round Table. He wanted to be one of its knights.</p>
                <p>Arthur liked Lancelot immediately. "You are welcome here," said the king. "I can see you are brave and true."</p>
                <p>Lancelot proved his worth many times. He saved Arthur's life in battle. He defeated the king's enemies. He rescued people in danger. Soon he was the most famous knight in all the land.</p>
                <p>But Lancelot had a secret. He loved Queen Guinevere. He knew this was wrong. She was his king's wife. But he could not help his feelings.</p>
                <p>Guinevere loved Lancelot too. She tried not to. She was Arthur's queen. But her heart belonged to Lancelot. This secret love would one day bring great trouble.</p>
                <p>For now, Lancelot tried to forget his love. He went on many adventures. He hoped that fighting would fill his heart.</p>
                <p>One day, Lancelot heard about a lady in danger. Her name was Lady Elaine. An evil knight had locked her in a tower of burning brass. The tower was so hot that no one could touch it.</p>
                <p>"I will save her," said Lancelot.</p>
                <p>He rode to the tower. He could feel the heat from far away. His horse would not go near it. So Lancelot walked.</p>
                <p>The heat burned his skin. His armor became hot. But Lancelot did not stop. He reached the tower door. He pushed it open. Inside he found Lady Elaine.</p>
                <p>"Thank you," she cried. "You saved me!"</p>
                <p>Lancelot carried her out. As soon as they were free, the tower disappeared. It had been made by magic.</p>
                <p>Lady Elaine fell in love with Lancelot. But Lancelot's heart belonged to Guinevere. This made Lady Elaine very sad.</p>
                <p>Another time, Lancelot was captured by an evil queen named Morgan le Fay. She was Arthur's half-sister. She knew magic and used it for evil.</p>
                <p>"You will marry one of us," Morgan said. Three other queens were with her. "Choose, or you will die."</p>
                <p>"I will not marry any of you," said Lancelot. "I would rather die."</p>
                <p>Morgan was angry. She locked Lancelot in a dungeon. But a servant girl helped him escape. She gave him his armor and his sword. Lancelot rode away free.</p>
                <p>On his way back to Camelot, Lancelot met a knight in black armor. The knight would not let him pass.</p>
                <p>"Fight me," said the black knight. "Or turn back."</p>
                <p>Lancelot fought him. The battle lasted all day. At last, Lancelot won. He took off the black knight's helmet. It was his friend, Sir Gawain!</p>
                <p>"Gawain!" cried Lancelot. "Why did you fight me?"</p>
                <p>Gawain laughed. "I wanted to test myself against the best knight. Now I know you are truly the greatest."</p>
                <p>The two knights became even better friends. They rode together back to Camelot. Arthur was happy to see them both.</p>
                <p>Lancelot had many more adventures. He fought giants and dragons. He broke evil spells. He helped the poor and the weak. Everyone loved him.</p>
                <p>But his secret love for Guinevere never went away. It waited in his heart like a sleeping dragon. One day it would wake up. And when it did, it would destroy everything.</p>`
            },
            {
                title: "Sir Gawain and the Green Knight",
                number: "Chapter 5",
                content: `<p class="first-para">It was New Year's Day at Camelot. King Arthur held a great feast. All the Knights of the Round Table were there. They ate and drank and told stories.</p>
                <p>Suddenly, the great doors flew open. A giant knight rode into the hall on a huge horse. But there was something strange about him. He was completely green. His skin was green. His hair was green. His armor was green. Even his horse was green.</p>
                <p>The Green Knight carried no sword. Instead, he held a great axe. The blade shone like silver.</p>
                <p>"I come with a challenge," said the Green Knight. His voice was like thunder. "Who will play a game with me?"</p>
                <p>"What game?" asked Arthur.</p>
                <p>"A simple game," said the Green Knight. "Someone may strike me once with this axe. But in one year, he must let me strike him back. Who is brave enough?"</p>
                <p>The knights looked at each other. This was a strange challenge. The axe could cut off a man's head. Who would agree to such a game?</p>
                <p>Sir Gawain stood up. "I will play your game," he said. "Give me the axe."</p>
                <p>The Green Knight smiled and handed over the axe. Then he knelt down. He bent his head. "Strike," he said.</p>
                <p>Gawain lifted the heavy axe. He swung it with all his might. The blade cut through the Green Knight's neck. The green head rolled across the floor.</p>
                <p>But then an amazing thing happened. The Green Knight did not die. His body stood up. It walked across the room. It picked up its own head!</p>
                <p>The Green Knight held his head in his hands. The head opened its eyes. The mouth began to speak.</p>
                <p>"Remember your promise, Sir Gawain. In one year, come to the Green Chapel. There you will take my blow."</p>
                <p>The Green Knight put his head back on his shoulders. He climbed onto his horse. He rode out of the hall. Everyone was too amazed to stop him.</p>
                <p>The year passed quickly. Gawain knew he must keep his promise. A knight must always keep his word, even if it means death.</p>
                <p>On New Year's Day, Gawain left Camelot. He rode through forests and mountains. He asked everyone about the Green Chapel. But no one had heard of it.</p>
                <p>At last, Gawain came to a castle. A lord welcomed him inside. "Stay here," said the lord. "Rest from your journey. The Green Chapel is very near."</p>
                <p>Gawain stayed at the castle for three days. The lord went hunting each day. His wife stayed home with Gawain. She was very beautiful. She tried to make Gawain kiss her.</p>
                <p>Gawain was a true knight. He would not kiss another man's wife. But she was very clever. On the third day, she gave him her green belt.</p>
                <p>"This belt has magic," she said. "Whoever wears it cannot be killed. Take it, and you will live."</p>
                <p>Gawain was afraid of the Green Knight's axe. He took the belt and hid it under his clothes.</p>
                <p>On New Year's Day, Gawain rode to the Green Chapel. It was a dark cave in the hillside. The Green Knight was waiting.</p>
                <p>"Kneel down," said the Green Knight. "Take my blow as you promised."</p>
                <p>Gawain knelt. He bent his head. The Green Knight raised his axe.</p>
                <p>The axe came down. But it only scratched Gawain's neck. A tiny cut appeared. One drop of blood fell.</p>
                <p>Gawain jumped up. "I took your blow! The game is finished!"</p>
                <p>The Green Knight laughed. "You are brave, Sir Gawain. But you are not perfect. You took the green belt. You tried to cheat death."</p>
                <p>Gawain was ashamed. "You are right," he said. "I was afraid. I was not as brave as I thought."</p>
                <p>"Do not be too hard on yourself," said the Green Knight. "You are only human. You made one small mistake. The scratch on your neck is your punishment. Now go home."</p>
                <p>Gawain rode back to Camelot. He told everyone what happened. He wore the green belt always. It reminded him to be humble. Even the bravest knight is not perfect.</p>`
            },
            {
                title: "The Quest for the Holy Grail",
                number: "Chapter 6",
                content: `<p class="first-para">One evening, something wonderful happened at Camelot. The knights were sitting at the Round Table. Suddenly, a bright light filled the room. It was brighter than the sun.</p>
                <p>In the light, they saw a cup. It floated in the air, covered with a white cloth. The cup moved slowly around the table. Then it disappeared.</p>
                <p>"What was that?" asked the knights.</p>
                <p>"That was the Holy Grail," said an old man who appeared in the doorway. "It is the cup that Jesus used at the Last Supper. It has great magic. It can heal any wound. It can make food appear. But only the purest knight can find it."</p>
                <p>The knights were excited. "We will find the Grail!" they cried. "We will bring it back to Camelot!"</p>
                <p>King Arthur was worried. "If you all leave, who will protect the kingdom?" he asked.</p>
                <p>But the knights had made up their minds. They took an oath to seek the Holy Grail. One by one, they left Camelot. They rode in different directions. Each one hoped to find the sacred cup.</p>
                <p>Sir Galahad was the purest knight. He was young and had never done wrong. His heart was completely good. One day, he came to the castle where the Round Table was. He sat in the Siege Perilous, the Dangerous Seat.</p>
                <p>Everyone gasped. They expected him to die. But Galahad did not die. He was the knight the seat was waiting for. The writing changed to his name.</p>
                <p>"You are the one," said Arthur. "You will find the Holy Grail."</p>
                <p>Galahad, Percival, and Bors rode together. They had many adventures. They fought evil knights. They helped people in trouble. They passed every test.</p>
                <p>Sir Lancelot searched too. But he could not find the Grail. His love for Guinevere was a sin. It made his heart impure.</p>
                <p>One night, Lancelot came to a chapel. Inside, he saw the Holy Grail. It glowed with beautiful light. Lancelot reached out to touch it.</p>
                <p>Fire came from the Grail. It struck Lancelot. He fell down as if dead. He lay there for many days. When he woke up, he was very sad.</p>
                <p>"I cannot touch the Grail," he said. "My heart is not pure enough. My love for the queen has cost me this great prize."</p>
                <p>But Galahad, Percival, and Bors succeeded. They came to a castle called Corbenic. The Holy Grail was there. An old king guarded it. He had been wounded long ago and could not die.</p>
                <p>"You have come at last," said the king. "The Grail will heal me now."</p>
                <p>Galahad took the Grail. He healed the old king. The king smiled and closed his eyes. At last, he could rest.</p>
                <p>Then Galahad looked into the Grail. He saw wonderful things. He saw heaven and angels. He saw the face of God.</p>
                <p>"I have seen everything," said Galahad. "Now I can die happy."</p>
                <p>A light came down from heaven. It took Galahad up to God. The purest knight had found the greatest treasure.</p>
                <p>Percival stayed at the castle. He became a holy man. He spent his life praying and helping others.</p>
                <p>Only Sir Bors returned to Camelot. He told everyone what happened. The knights listened in wonder. The Holy Grail was the greatest adventure of all.</p>
                <p>But the quest had cost much. Many knights died searching. Many never came back. The Round Table was not as full as before. The golden days of Camelot were ending.</p>`
            },
            {
                title: "The Betrayal",
                number: "Chapter 7",
                content: `<p class="first-para">After the quest for the Holy Grail, things changed at Camelot. Many good knights were gone. The Round Table seemed empty. King Arthur was older now. His hair was gray.</p>
                <p>The secret love between Lancelot and Guinevere grew stronger. They tried to hide it. But secrets have a way of coming out.</p>
                <p>Arthur's nephew, Sir Mordred, was jealous and evil. He hated Arthur. He wanted to be king himself. He watched Lancelot and Guinevere carefully. He was waiting for a chance to make trouble.</p>
                <p>One night, Mordred and his friends caught Lancelot in the queen's room. "Traitor!" they shouted. "We will tell the king!"</p>
                <p>Lancelot fought his way out. He killed many knights. But the damage was done. Everyone knew the secret now.</p>
                <p>Arthur was heartbroken. He loved both Lancelot and Guinevere. But the law was clear. The queen must be punished for betraying the king.</p>
                <p>"Guinevere must die," said the lords. "That is the law."</p>
                <p>Arthur could not change the law. With a heavy heart, he ordered Guinevere to be burned. It was the punishment for treason.</p>
                <p>Lancelot could not let this happen. He gathered his friends. On the day of the burning, they attacked. Lancelot rescued Guinevere. But in the fight, he killed Sir Gareth and Sir Gaheris. They were brothers of Sir Gawain.</p>
                <p>Gawain had been Lancelot's friend. But now his brothers were dead. "I will never forgive you!" Gawain told Lancelot. "I will hunt you until one of us dies!"</p>
                <p>Lancelot took Guinevere to France. Arthur and Gawain followed with an army. They wanted revenge.</p>
                <p>While Arthur was gone, Mordred made his move. He told everyone that Arthur was dead. He made himself king. He even tried to marry Guinevere.</p>
                <p>But Guinevere did not believe Arthur was dead. She locked herself in the Tower of London. She would not come out.</p>
                <p>Arthur heard what Mordred had done. He rushed back to Britain. His heart was full of anger and sorrow.</p>
                <p>Gawain was wounded in the fighting in France. On the ship home, he became very sick. He knew he was dying.</p>
                <p>"I was wrong to fight Lancelot," Gawain said. "He was our friend. Write to him, uncle. Tell him to come help you fight Mordred."</p>
                <p>Arthur wrote the letter. But it was too late. Gawain died before they reached Britain.</p>
                <p>Arthur was very sad. So many good knights were dead. His kingdom was broken. His wife was gone. His best friend was his enemy. And his nephew was a traitor.</p>
                <p>"This is the end," Arthur thought. "Everything I built is falling apart."</p>
                <p>The great Round Table was cracked. The golden days were over. Now came the darkness.</p>`
            },
            {
                title: "The Last Battle",
                number: "Chapter 8",
                content: `<p class="first-para">King Arthur gathered his army. He marched to fight Mordred. The two armies met at a place called Camlann.</p>
                <p>Arthur's heart was heavy. He did not want this war. Mordred was his nephew. Some stories say Mordred was actually Arthur's son. Either way, this battle was a tragedy.</p>
                <p>The night before the battle, Arthur had a dream. He saw Gawain's ghost. "Do not fight tomorrow," Gawain warned. "Make peace with Mordred. Wait for Lancelot to come. If you fight tomorrow, you will die."</p>
                <p>Arthur woke up afraid. He sent messengers to Mordred. "Let us make peace," he said. "We can share the kingdom."</p>
                <p>Mordred agreed to meet. But he did not trust Arthur. "If you see anyone draw a sword," he told his men, "attack immediately."</p>
                <p>Arthur told his men the same thing. Both sides were nervous.</p>
                <p>The two leaders met between the armies. They began to talk. Perhaps they could find peace. Perhaps the war could be stopped.</p>
                <p>But then a snake slithered through the grass. It bit one of Mordred's knights. The knight drew his sword to kill the snake.</p>
                <p>Everyone saw the sword flash in the sun. "Treachery!" both sides shouted. The battle began.</p>
                <p>It was the worst battle in British history. Knights who had been friends now killed each other. The grass turned red with blood. By the end of the day, almost everyone was dead.</p>
                <p>Arthur saw Mordred across the battlefield. He picked up a spear. "Traitor!" he shouted. "Now you will die!"</p>
                <p>Arthur ran at Mordred. He stabbed him with the spear. The spear went through Mordred's body.</p>
                <p>But Mordred was not finished. With his last strength, he swung his sword. It hit Arthur's head. Arthur fell to the ground.</p>
                <p>Mordred died with the spear still in him. Arthur lay wounded, near death.</p>
                <p>Only one knight survived. Sir Bedivere found the king lying by the water. Arthur was bleeding badly. He knew he did not have long to live.</p>
                <p>"Take Excalibur," Arthur told Bedivere. "Throw it into the lake. Then come tell me what you see."</p>
                <p>Bedivere took the sword. It was so beautiful. He did not want to throw it away. He hid it under a tree. He went back to Arthur.</p>
                <p>"What did you see?" asked Arthur.</p>
                <p>"Only waves on the water," said Bedivere.</p>
                <p>"You are lying," said Arthur. "Go back and throw the sword."</p>
                <p>Bedivere tried again. But again he could not do it. He hid the sword and went back to Arthur.</p>
                <p>"What did you see?"</p>
                <p>"Only wind on the water."</p>
                <p>"Traitor!" said Arthur. "Would you betray your dying king? Go back and throw the sword!"</p>
                <p>This time, Bedivere obeyed. He threw Excalibur far out over the lake. A hand rose from the water. It caught the sword. It waved it three times. Then it sank beneath the waves.</p>
                <p>Bedivere ran back to Arthur. "I saw a hand catch the sword!" he said. "The Lady of the Lake has taken it back."</p>
                <p>"Good," said Arthur. "Now carry me to the shore."</p>
                <p>Bedivere carried the king to the water's edge. A boat was waiting there. Three queens sat in the boat. They wore black hoods.</p>
                <p>"Put me in the boat," said Arthur.</p>
                <p>Bedivere laid the king in the boat. One of the queens put Arthur's head in her lap. She was Morgan le Fay, Arthur's sister. She was crying.</p>
                <p>"Where are you going?" asked Bedivere.</p>
                <p>"To Avalon," said Arthur. "To heal my wounds. Perhaps I will return one day. When Britain needs me most, I will come back."</p>
                <p>The boat sailed away into the mist. Bedivere watched until he could see it no more. Then he fell to his knees and wept.</p>
                <p>King Arthur was gone. Camelot fell into ruins. The Knights of the Round Table were dead or scattered. The golden age was over.</p>
                <p>But people never forgot Arthur. They told stories about him for hundreds of years. They still tell them today. And some say Arthur is not dead. He is only sleeping in Avalon. One day, when Britain needs him most, the king will return.</p>`
            },
            {
                title: "The Legend Lives On",
                number: "Epilogue",
                content: `<p class="first-para">What happened after Arthur left? The stories tell us a little more.</p>
                <p>Lancelot finally received Gawain's letter. He sailed to Britain with his army. But he arrived too late. Arthur was gone. The battle was over.</p>
                <p>Lancelot found Guinevere. She had become a nun. She lived in a convent, praying for forgiveness.</p>
                <p>"I caused all this trouble," Guinevere said. "Our love destroyed the kingdom. I will spend the rest of my life praying."</p>
                <p>Lancelot wanted to take her away. But Guinevere refused. "Go back to France," she said. "Forget me. This is goodbye."</p>
                <p>Lancelot left with a broken heart. He became a holy man, like Guinevere. He spent his days praying and helping the poor. When he died, people said he was smiling. Perhaps he finally found peace.</p>
                <p>Sir Bedivere became a hermit. He lived alone in the forest. Every day, he visited Arthur's grave. He never forgot his king.</p>
                <p>Some stories say there is no grave. They say Arthur sleeps in a cave, waiting to return. When Britain faces its greatest danger, Arthur will wake up. He will save his country one more time.</p>
                <p>The stories of King Arthur spread across the world. Writers and poets told them again and again. Each time, they added new details. New adventures. New knights.</p>
                <p>Why do we still love these stories? Perhaps because they show us what we want to be. Arthur was a good king who tried to make the world better. The knights were brave and true. They fought for what was right.</p>
                <p>The Round Table was a beautiful idea. Everyone sitting as equals. No one more important than another. This is what the world could be like.</p>
                <p>Yes, the story ends sadly. Arthur dies. Camelot falls. The Round Table breaks. But that is life. Good things do not last forever. What matters is that they existed at all.</p>
                <p>Arthur showed us that one person can make a difference. He pulled a sword from a stone. He built a kingdom of justice. He gathered brave knights to fight for good. For a while, Camelot was the brightest place on Earth.</p>
                <p>So the legend lives on. In books and movies. In songs and plays. Every time someone tells the story, Arthur lives again.</p>
                <p>And who knows? Perhaps one day, when we need him most, the king will return. Perhaps he is out there somewhere, waiting. Sleeping under a hill of green grass. Ready to wake up and save us all.</p>
                <p>The once and future king.</p>
                <p style="text-align: center; margin-top: 40px; font-style: italic;">THE END</p>`
            }
        ];

        // App State
        let currentPage = 0;
        let totalPages = 0;
        let pages = [];
        let fontSize = 100;
        let theme = 'light';
        let bookmarks = [];
        let uiVisible = false;

        // DOM Elements
        const reader = document.getElementById('reader');
        const pagesContainer = document.getElementById('pagesContainer');
        const header = document.getElementById('header');
        const footer = document.getElementById('footer');
        const pageSlider = document.getElementById('pageSlider');
        const pageInfo = document.getElementById('pageInfo');
        const tocBtn = document.getElementById('tocBtn');
        const tocPanel = document.getElementById('tocPanel');
        const tocList = document.getElementById('tocList');
        const closeToc = document.getElementById('closeToc');
        const overlay = document.getElementById('overlay');
        const searchBtn = document.getElementById('searchBtn');
        const searchPanel = document.getElementById('searchPanel');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const closeSearch = document.getElementById('closeSearch');
        const bookmarkBtn = document.getElementById('bookmarkBtn');
        const fontBtn = document.getElementById('fontBtn');
        const fontPanel = document.getElementById('fontPanel');
        const fontDecrease = document.getElementById('fontDecrease');
        const fontIncrease = document.getElementById('fontIncrease');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        const themeButtons = document.querySelectorAll('.theme-btn');
        const gridBtn = document.getElementById('gridBtn');
        const pageGrid = document.getElementById('pageGrid');
        const pageGridInner = document.getElementById('pageGridInner');
        const touchLeft = document.getElementById('touchLeft');
        const touchCenter = document.getElementById('touchCenter');
        const touchRight = document.getElementById('touchRight');
        const loadingScreen = document.getElementById('loadingScreen');
        const sliderStart = document.getElementById('sliderStart');
        const sliderEnd = document.getElementById('sliderEnd');

        // Initialize
        function init() {
            loadSettings();
            paginateContent();
            buildTOC();
            setupEventListeners();
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, 600);
        }

        // Paginate content into screen-sized pages
        function paginateContent() {
            pages = [];
            const pageHeight = window.innerHeight - 80; // Leave room for padding
            const tempDiv = document.createElement('div');
            tempDiv.style.cssText = `
                position: absolute;
                visibility: hidden;
                width: ${window.innerWidth - 60}px;
                font-size: ${fontSize}%;
                line-height: 1.75;
                font-family: Georgia, serif;
            `;
            document.body.appendChild(tempDiv);

            bookContent.forEach((chapter, chapterIndex) => {
                // Create chapter header page
                const headerHTML = `
                    <div class="chapter-header">
                        <div class="chapter-number">${chapter.number}</div>
                        <div class="chapter-title">${chapter.title}</div>
                    </div>
                `;

                // Parse content into paragraphs
                const contentDiv = document.createElement('div');
                contentDiv.innerHTML = chapter.content;
                const paragraphs = Array.from(contentDiv.querySelectorAll('p'));

                let currentPageContent = headerHTML;
                let isFirstPage = true;

                paragraphs.forEach((p, pIndex) => {
                    const pHTML = p.outerHTML;
                    tempDiv.innerHTML = currentPageContent + pHTML;

                    if (tempDiv.offsetHeight > pageHeight && currentPageContent !== headerHTML) {
                        // Save current page
                        pages.push({
                            content: currentPageContent,
                            chapterIndex,
                            chapterTitle: chapter.title
                        });
                        currentPageContent = pHTML;
                        isFirstPage = false;
                    } else {
                        currentPageContent += pHTML;
                    }
                });

                // Save last page of chapter
                if (currentPageContent) {
                    pages.push({
                        content: currentPageContent,
                        chapterIndex,
                        chapterTitle: chapter.title
                    });
                }
            });

            document.body.removeChild(tempDiv);
            totalPages = pages.length;

            // Update slider
            pageSlider.max = totalPages;
            pageSlider.value = currentPage + 1;
            sliderEnd.textContent = totalPages;

            renderPages();
        }

        // Render visible pages
        function renderPages() {
            pagesContainer.innerHTML = '';

            // Render current page and neighbors for smooth transitions
            for (let i = Math.max(0, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                const pageEl = document.createElement('div');
                pageEl.className = 'page';
                pageEl.dataset.page = i;

                const isBookmarked = bookmarks.includes(i);

                pageEl.innerHTML = `
                    <div class="page-bookmark ${isBookmarked ? 'active' : 'visible'}" data-page="${i}">&#128278;</div>
                    <div class="page-content" style="font-size: ${fontSize}%;">
                        ${pages[i].content}
                    </div>
                `;
                pagesContainer.appendChild(pageEl);
            }

            // Position container to show current page
            const offset = currentPage > 0 ? -100 : 0;
            pagesContainer.style.transform = `translateX(${offset}vw)`;

            updateUI();
        }

        // Update UI elements
        function updateUI() {
            const progress = Math.round(((currentPage + 1) / totalPages) * 100);
            pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages} Â· ${progress}%`;
            pageSlider.value = currentPage + 1;

            // Update bookmark button
            const isBookmarked = bookmarks.includes(currentPage);
            bookmarkBtn.style.opacity = isBookmarked ? '1' : '0.7';

            // Update TOC active state
            const currentChapter = pages[currentPage]?.chapterIndex;
            document.querySelectorAll('.toc-item').forEach((item, index) => {
                item.classList.toggle('active', index === currentChapter);
            });
        }

        // Navigate pages
        function goToPage(pageNum) {
            if (pageNum >= 0 && pageNum < totalPages) {
                currentPage = pageNum;
                renderPages();
                saveSettings();
            }
        }

        function nextPage() {
            if (currentPage < totalPages - 1) {
                goToPage(currentPage + 1);
            }
        }

        function prevPage() {
            if (currentPage > 0) {
                goToPage(currentPage - 1);
            }
        }

        // Toggle UI visibility
        function toggleUI() {
            uiVisible = !uiVisible;
            header.classList.toggle('visible', uiVisible);
            footer.classList.toggle('visible', uiVisible);

            // Hide panels when toggling UI
            if (!uiVisible) {
                fontPanel.classList.remove('visible');
                pageGrid.classList.remove('visible');
            }
        }

        // Build Table of Contents
        function buildTOC() {
            tocList.innerHTML = '';
            bookContent.forEach((chapter, index) => {
                const item = document.createElement('li');
                item.className = 'toc-item';
                item.innerHTML = `
                    <span class="chapter-num">${chapter.number}</span>
                    ${chapter.title}
                `;
                item.addEventListener('click', () => {
                    // Find first page of this chapter
                    const pageIndex = pages.findIndex(p => p.chapterIndex === index);
                    if (pageIndex >= 0) {
                        goToPage(pageIndex);
                        closeTOC();
                    }
                });
                tocList.appendChild(item);
            });
        }

        // TOC Panel
        function openTOC() {
            tocPanel.classList.add('visible');
            overlay.classList.add('visible');
            updateUI();
        }

        function closeTOC() {
            tocPanel.classList.remove('visible');
            overlay.classList.remove('visible');
        }

        // Search
        function openSearch() {
            searchPanel.classList.add('visible');
            searchInput.focus();
        }

        function closeSearchPanel() {
            searchPanel.classList.remove('visible');
            searchInput.value = '';
            searchResults.innerHTML = '';
        }

        function performSearch(query) {
            if (query.length < 2) {
                searchResults.innerHTML = '';
                return;
            }

            const results = [];
            const lowerQuery = query.toLowerCase();

            bookContent.forEach((chapter, chapterIndex) => {
                const text = chapter.content.replace(/<[^>]*>/g, '');
                let index = 0;

                while ((index = text.toLowerCase().indexOf(lowerQuery, index)) !== -1) {
                    const start = Math.max(0, index - 40);
                    const end = Math.min(text.length, index + query.length + 40);
                    let context = text.substring(start, end);

                    if (start > 0) context = '...' + context;
                    if (end < text.length) context = context + '...';

                    // Highlight match
                    const highlightedContext = context.replace(
                        new RegExp(query, 'gi'),
                        '<span class="highlight">$&</span>'
                    );

                    results.push({
                        chapterIndex,
                        chapterTitle: chapter.title,
                        context: highlightedContext
                    });

                    index += query.length;
                    if (results.length >= 20) break;
                }

                if (results.length >= 20) return;
            });

            searchResults.innerHTML = results.map(r => `
                <div class="search-result" data-chapter="${r.chapterIndex}">
                    <div class="context">${r.context}</div>
                    <div class="chapter-name">${r.chapterTitle}</div>
                </div>
            `).join('') || '<div style="padding: 20px; color: #888;">No results found</div>';

            // Add click handlers
            searchResults.querySelectorAll('.search-result').forEach(el => {
                el.addEventListener('click', () => {
                    const chapterIndex = parseInt(el.dataset.chapter);
                    const pageIndex = pages.findIndex(p => p.chapterIndex === chapterIndex);
                    if (pageIndex >= 0) {
                        goToPage(pageIndex);
                        closeSearchPanel();
                    }
                });
            });
        }

        // Bookmarks
        function toggleBookmark() {
            const index = bookmarks.indexOf(currentPage);
            if (index === -1) {
                bookmarks.push(currentPage);
            } else {
                bookmarks.splice(index, 1);
            }
            renderPages();
            saveSettings();
        }

        // Font settings
        function toggleFontPanel() {
            fontPanel.classList.toggle('visible');
            pageGrid.classList.remove('visible');
        }

        function changeFontSize(delta) {
            fontSize = Math.max(70, Math.min(150, fontSize + delta));
            fontSizeDisplay.textContent = fontSize + '%';
            paginateContent();
            saveSettings();
        }

        function applyTheme(newTheme) {
            theme = newTheme;
            document.body.classList.remove('dark-mode', 'sepia-mode');
            if (theme === 'dark') document.body.classList.add('dark-mode');
            if (theme === 'sepia') document.body.classList.add('sepia-mode');

            themeButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === theme);
            });
            saveSettings();
        }

        // Page grid navigator
        function togglePageGrid() {
            pageGrid.classList.toggle('visible');
            fontPanel.classList.remove('visible');

            if (pageGrid.classList.contains('visible')) {
                buildPageGrid();
            }
        }

        function buildPageGrid() {
            pageGridInner.innerHTML = '';
            for (let i = 0; i < totalPages; i++) {
                const thumb = document.createElement('div');
                thumb.className = 'page-thumb' + (i === currentPage ? ' active' : '');
                thumb.textContent = i + 1;
                thumb.addEventListener('click', () => {
                    goToPage(i);
                    pageGrid.classList.remove('visible');
                });
                pageGridInner.appendChild(thumb);
            }

            // Scroll to current page
            const activeThumb = pageGridInner.querySelector('.active');
            if (activeThumb) {
                activeThumb.scrollIntoView({ inline: 'center', behavior: 'smooth' });
            }
        }

        // Settings persistence
        function loadSettings() {
            const saved = localStorage.getItem('kingArthurKindle');
            if (saved) {
                const settings = JSON.parse(saved);
                currentPage = settings.currentPage || 0;
                fontSize = settings.fontSize || 100;
                theme = settings.theme || 'light';
                bookmarks = settings.bookmarks || [];
            }
            applyTheme(theme);
            fontSizeDisplay.textContent = fontSize + '%';
        }

        function saveSettings() {
            localStorage.setItem('kingArthurKindle', JSON.stringify({
                currentPage,
                fontSize,
                theme,
                bookmarks
            }));
        }

        // Event listeners
        function setupEventListeners() {
            // Touch zones
            touchLeft.addEventListener('click', prevPage);
            touchRight.addEventListener('click', nextPage);
            touchCenter.addEventListener('click', toggleUI);

            // Swipe support
            let touchStartX = 0;
            let touchStartY = 0;

            reader.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            reader.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;

                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    if (diffX > 0) nextPage();
                    else prevPage();
                }
            }, { passive: true });

            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (searchPanel.classList.contains('visible')) return;

                switch(e.key) {
                    case 'ArrowRight':
                    case ' ':
                        nextPage();
                        e.preventDefault();
                        break;
                    case 'ArrowLeft':
                        prevPage();
                        e.preventDefault();
                        break;
                    case 'Escape':
                        closeTOC();
                        closeSearchPanel();
                        fontPanel.classList.remove('visible');
                        pageGrid.classList.remove('visible');
                        break;
                }
            });

            // Slider
            pageSlider.addEventListener('input', () => {
                goToPage(parseInt(pageSlider.value) - 1);
            });

            // TOC
            tocBtn.addEventListener('click', openTOC);
            closeToc.addEventListener('click', closeTOC);
            overlay.addEventListener('click', () => {
                closeTOC();
                fontPanel.classList.remove('visible');
                pageGrid.classList.remove('visible');
            });

            // Search
            searchBtn.addEventListener('click', openSearch);
            closeSearch.addEventListener('click', closeSearchPanel);
            searchInput.addEventListener('input', (e) => performSearch(e.target.value));

            // Bookmark
            bookmarkBtn.addEventListener('click', toggleBookmark);

            // Font settings
            fontBtn.addEventListener('click', toggleFontPanel);
            fontDecrease.addEventListener('click', () => changeFontSize(-10));
            fontIncrease.addEventListener('click', () => changeFontSize(10));
            themeButtons.forEach(btn => {
                btn.addEventListener('click', () => applyTheme(btn.dataset.theme));
            });

            // Page grid
            gridBtn.addEventListener('click', togglePageGrid);

            // Handle resize
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    paginateContent();
                }, 250);
            });
        }

        // Start
        init();
    </script>
</body>
</html>
